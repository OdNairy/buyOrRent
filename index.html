<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конфигурируемый анализ: Покупка vs. Аренда (с налогами)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Application Structure Plan: 
        1. Header: Title.
        2. Introduction: Brief explanation.
        3. Configuration Section: Input fields for user-defined parameters including tax rates, with debounced automatic recalculation.
        4. Financial Outcome Summary: Comparative summary of buying vs. renting & investing scenarios, with "Pre-Tax" and "Post-Tax" sub-sections, highlighting scenario profit and investment profit.
        5. Main Interactive Area (Net Flow Analysis):
            - Bar chart visualizing monthly net investment/withdrawal.
            - Key summary figures (total net investment for cash flow equalization).
        6. Data Table Section: Detailed monthly data for net flow analysis.
        7. Key Insights Section: Explanatory text.
        8. Footer.
        This structure allows users to configure parameters (including taxes) and see a comprehensive financial outcome comparison (pre and post-tax), alongside cash flow details.
    -->
    <!-- Visualization & Content Choices:
        - Report Info: User-configurable parameters driving all calculations.
        - Goal: Allow users to explore how different financial parameters, including taxes, affect the net cash flow difference and overall financial outcome, with scenario profit as the main metric.
        - Viz/Presentation Method: Bar Chart (Chart.js) for net flow, HTML Table for detailed data, Text summary for financial outcomes (pre/post-tax). Input fields for configuration.
        - Interaction: User input changes parameters, triggering debounced automatic recalculation. Chart tooltips.
        - Justification: Comprehensive analysis including tax impact. Debounced updates for smooth UX. Scenario profit and investment profit clearly displayed.
        - Library/Method: Chart.js, Tailwind CSS, Vanilla JavaScript.
        - Content: Default values based on previous scenario. Labels and explanations in Russian.
    -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 500px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 450px;
            }
        }
        .table-responsive {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569; /* slate-600 */
        }
        .input-group input[type="number"], .input-group select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .input-group input[type="number"]:focus, .input-group select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #0284c7; /* sky-600 */
            box-shadow: 0 0 0 2px #38bdf8; /* sky-400 */
        }
        .input-value-unit-container {
            display: flex;
            align-items: center;
        }
        .input-value-unit-container input[type="number"] {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            flex-grow: 1;
        }
        .input-value-unit-container .unit-suffix {
            padding: 0.5rem 0.75rem;
            background-color: #e2e8f0; /* slate-200 */
            border: 1px solid #cbd5e1; /* slate-300 */
            border-left: none;
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            font-size: 0.875rem;
            color: #475569; /* slate-600 */
            white-space: nowrap;
        }
        .summary-divider {
            border-top: 2px dashed #94a3b8; /* slate-400 */
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-700">Конфигурируемый анализ: Покупка квартиры vs. Аренда с инвестициями</h1>
            <p class="text-lg text-slate-600 mt-2">Сравнение финансовых результатов и ежемесячных денежных потоков (с учетом налогов)</p>
        </header>

        <section id="introduction" class="mb-10 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-sky-600 mb-3">Обзор анализа</h2>
            <p class="text-base leading-relaxed">
                Это приложение позволяет настроить ключевые финансовые параметры для сравнения двух сценариев: покупки недвижимости и аренды с одновременным инвестированием свободных средств.
                Вы можете увидеть как общий финансовый итог по каждому сценарию (до и после налогов), так и детализацию ежемесячных денежных потоков, необходимых для уравнивания расходов.
                Измените параметры ниже, и результаты обновятся автоматически с небольшой задержкой для удобства ввода.
            </p>
        </section>

        <section id="configuration" class="mb-10 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-sky-600 mb-6">Параметры конфигурации</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-6 gap-y-4">
                <div class="input-group">
                    <label for="apartmentCost">Стоимость квартиры (EUR)</label>
                    <input type="number" id="apartmentCost" value="427000" step="5000">
                </div>
                
                <div class="input-group">
                    <label for="initialInvestmentType">Тип первоначального взноса</label>
                    <select id="initialInvestmentType">
                        <option value="percentage">Процент от стоимости</option>
                        <option value="value">Фиксированная сумма</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="initialInvestmentConfigValue">Значение первоначального взноса</label>
                    <div class="input-value-unit-container">
                        <input type="number" id="initialInvestmentConfigValue" value="30">
                        <span id="initialInvestmentUnitSuffix" class="unit-suffix">%</span>
                    </div>
                </div>

                <div class="input-group">
                    <label for="mortgageTermYears">Срок ипотеки (лет)</label>
                    <input type="number" id="mortgageTermYears" value="25" min="1" max="50">
                </div>
                <div class="input-group">
                    <label for="mortgageAnnualRate">Годовая ставка по ипотеке (%)</label>
                    <input type="number" id="mortgageAnnualRate" value="2.7" step="0.05" min="0">
                </div>
                <div class="input-group">
                    <label for="initialMonthlyRent">Начальная ежемесячная аренда (EUR)</label>
                    <input type="number" id="initialMonthlyRent" value="1700" step="20">
                </div>
                <div class="input-group">
                    <label for="rentIndexRate">Годовая индексация аренды (%)</label>
                    <input type="number" id="rentIndexRate" value="1.5" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="initialMonthlyMaintenance">Начальное ежемес. обслуживание (EUR)</label>
                    <input type="number" id="initialMonthlyMaintenance" value="550" step="10">
                </div>
                <div class="input-group">
                    <label for="maintenanceIndexRate">Годовая индексация обслуживания (%)</label>
                    <input type="number" id="maintenanceIndexRate" value="1.0" step="0.1" min="0">
                </div>
                 <div class="input-group">
                    <label for="sp500Rate">Среднегодовая доходность S&P 500 (%)</label>
                    <input type="number" id="sp500Rate" value="9.0" step="0.2">
                </div>
                <div class="input-group">
                    <label for="propertyGrowthRate">Среднегодовой рост недвижимости (%)</label>
                    <input type="number" id="propertyGrowthRate" value="2.5" step="0.1">
                </div>
                <div class="input-group">
                    <label for="propertySaleTaxRate">Налог на продажу квартиры (%)</label>
                    <input type="number" id="propertySaleTaxRate" value="0" step="0.1" min="0">
                </div>
                <div class="input-group">
                    <label for="investmentSaleTaxRate">Налог на продажу инвестиций (%)</label>
                    <input type="number" id="investmentSaleTaxRate" value="34" step="0.1" min="0">
                </div>
            </div>
        </section>
        
        <section id="financial-outcome-summary" class="mb-10 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-sky-600 mb-4 text-center">Сравнительный финансовый итог за <span id="summaryTermYears">25</span> лет</h2>
            
            <div>
                <h3 class="text-xl font-bold text-slate-800 mb-3 text-center">До Налогов</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                        <h4 class="text-lg font-semibold text-slate-700 mb-2">Сценарий: Покупка недвижимости</h4>
                        <p class="text-sm text-slate-600">Прибыль по сценарию:</p>
                        <p><strong id="scenarioProfitBuyPreTax" class="text-2xl text-sky-700">0</strong> EUR</p>
                        <hr class="my-2">
                        <p class="text-xs text-slate-500 mt-1">Прогнозируемая стоимость недвижимости: <span id="futurePropertyValuePreTax">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Первоначальный взнос: <span id="summaryInitialInvestmentBuyPreTax">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Всего процентов по ипотеке: <span id="totalInterestPaidOutputPreTax">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Всего расходов на обслуживание: <span id="totalMaintenancePaidOutputPreTax">0</span> EUR</p>
                    </div>
                    <div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                        <h4 class="text-lg font-semibold text-slate-700 mb-2">Сценарий: Аренда + Инвестиции в S&P 500</h4>
                        <p class="text-sm text-slate-600">Прибыль по сценарию:</p>
                        <p><strong id="scenarioProfitRentInvestPreTax" class="text-2xl text-sky-700">0</strong> EUR</p>
                        <hr class="my-2">
                        <p class="text-xs text-slate-500 mt-1">Прогнозируемая стоимость портфеля: <span id="futurePortfolioValuePreTax">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Прибыль от инвестиций: <span id="investmentProfitPreTaxOutput">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Первоначальные инвестиции: <span id="summaryInitialInvestmentRentPreTax">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Доходность S&P 500 (среднегодовая): <span id="summarySP500RatePreTax">0</span>%</p>
                        <p class="text-xs text-slate-500">Всего расходов на аренду: <span id="totalRentPaidOutputPreTax">0</span> EUR</p>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <p class="text-xl font-semibold">Разница в итоговой прибыли (до налогов): <strong id="capitalDifferencePreTax" class="text-sky-700">0</strong> EUR</p>
                    <p id="capitalDifferenceFavourPreTax" class="text-md text-slate-600"></p>
                </div>
            </div>

            <div class="summary-divider"></div>

            <div>
                <h3 class="text-xl font-bold text-slate-800 mb-3 text-center">После Налогов</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                        <h4 class="text-lg font-semibold text-slate-700 mb-2">Сценарий: Покупка недвижимости</h4>
                        <p class="text-sm text-slate-600">Прибыль по сценарию (после налога):</p>
                        <p><strong id="scenarioProfitBuyPostTax" class="text-2xl text-sky-700">0</strong> EUR</p>
                        <hr class="my-2">
                        <p class="text-xs text-slate-500 mt-1">Стоимость недвижимости (после налога): <span id="futurePropertyValuePostTax">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Прирост капитала (до налога): <span id="propertyGainPreTaxOutput">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Налог на продажу квартиры (<span id="propertySaleTaxRateOutput">0</span>%): <span id="propertyTaxAmountOutput">0</span> EUR</p>
                    </div>
                    <div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                        <h4 class="text-lg font-semibold text-slate-700 mb-2">Сценарий: Аренда + Инвестиции в S&P 500</h4>
                        <p class="text-sm text-slate-600">Прибыль по сценарию (после налога):</p>
                        <p><strong id="scenarioProfitRentInvestPostTax" class="text-2xl text-sky-700">0</strong> EUR</p>
                        <hr class="my-2">
                        <p class="text-xs text-slate-500 mt-1">Стоимость портфеля (после налога): <span id="futurePortfolioValuePostTax">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Прибыль от инвестиций (после налога): <span id="investmentProfitPostTaxOutput">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Прирост капитала (до налога): <span id="portfolioGainPreTaxOutput">0</span> EUR</p>
                        <p class="text-xs text-slate-500">Налог на продажу инвестиций (<span id="investmentSaleTaxRateOutput">0</span>%): <span id="investmentTaxAmountOutput">0</span> EUR</p>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <p class="text-xl font-semibold">Разница в итоговой прибыли (после налогов): <strong id="capitalDifferencePostTax" class="text-sky-700">0</strong> EUR</p>
                    <p id="capitalDifferenceFavourPostTax" class="text-md text-slate-600"></p>
                </div>
            </div>
        </section>

        <section id="chart-visualization" class="mb-10 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-sky-600 mb-1 text-center">Анализ ежемесячных денежных потоков для уравнивания расходов</h2>
            <p class="text-sm text-slate-500 text-center mb-4">(Положительное значение = доинвестирование в S&P 500, т.к. покупка дороже аренды в этом месяце)</p>
            <div class="chart-container">
                <canvas id="netInvestmentChart"></canvas>
            </div>
            <p id="total-net-investment" class="mt-4 text-center text-lg font-semibold text-slate-700"></p>
        </section>

        <section id="data-table-section" class="mb-10 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-sky-600 mb-4">Детализация ежемесячных денежных потоков</h2>
            <div class="table-responsive">
                <table class="min-w-full divide-y divide-slate-200 border border-slate-200 rounded-md">
                    <thead class="bg-slate-100 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Месяц</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Обслуживание (покупка, EUR)</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Проценты по ипотеке (EUR)</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Аренда (EUR)</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Общие расходы при покупке (EUR)</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Чистый поток (доинвест./изъятие, EUR)</th>
                        </tr>
                    </thead>
                    <tbody id="investmentDataBody" class="bg-white divide-y divide-slate-200">
                    </tbody>
                </table>
            </div>
        </section>

        <section id="key-insights" class="mb-10 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-sky-600 mb-3">Ключевые выводы и примечания</h2>
            <div class="text-base leading-relaxed space-y-3">
                <p><strong>Примечание:</strong> "Ежемесячное обслуживание" и "Ежемесячная аренда" индексируются ежегодно. "Общие ежемесячные расходы при покупке" включают ипотечный платеж (основной долг + проценты) и обслуживание. "Чистый поток" - это разница между расходами на покупку и аренду, которая в сценарии "Аренда + Инвестиции" направляется в/изымается из инвестиционного портфеля для уравнивания ежемесячных затрат.</p>
                <p>Секция "Сравнительный финансовый итог" показывает, какой капитал будет накоплен в каждом сценарии к концу срока, как до, так и после учета налогов. Секция "Анализ ежемесячных денежных потоков" детализирует, какие суммы ежемесячно перераспределяются для поддержания одинаковых текущих расходов.</p>
            </div>
        </section>

        <footer class="text-center py-8 text-slate-500">
            <p>&copy; <span id="currentYear"></span> Аналитическое приложение. Все права защищены.</p>
        </footer>
    </div>

    <script>
        let netInvestmentChartInstance;
        let debounceTimer;

        const configElements = {
            apartmentCost: document.getElementById('apartmentCost'),
            initialInvestmentType: document.getElementById('initialInvestmentType'),
            initialInvestmentConfigValue: document.getElementById('initialInvestmentConfigValue'),
            initialInvestmentUnitSuffix: document.getElementById('initialInvestmentUnitSuffix'),
            mortgageTermYears: document.getElementById('mortgageTermYears'),
            mortgageAnnualRate: document.getElementById('mortgageAnnualRate'),
            initialMonthlyRent: document.getElementById('initialMonthlyRent'),
            rentIndexRate: document.getElementById('rentIndexRate'),
            initialMonthlyMaintenance: document.getElementById('initialMonthlyMaintenance'),
            maintenanceIndexRate: document.getElementById('maintenanceIndexRate'),
            sp500Rate: document.getElementById('sp500Rate'),
            propertyGrowthRate: document.getElementById('propertyGrowthRate'),
            propertySaleTaxRate: document.getElementById('propertySaleTaxRate'),
            investmentSaleTaxRate: document.getElementById('investmentSaleTaxRate')
        };
        
        const summaryElements = {
            summaryTermYears: document.getElementById('summaryTermYears'),
            // Pre-Tax
            scenarioProfitBuyPreTax: document.getElementById('scenarioProfitBuyPreTax'),
            futurePropertyValuePreTax: document.getElementById('futurePropertyValuePreTax'),
            summaryInitialInvestmentBuyPreTax: document.getElementById('summaryInitialInvestmentBuyPreTax'),
            totalInterestPaidOutputPreTax: document.getElementById('totalInterestPaidOutputPreTax'),
            totalMaintenancePaidOutputPreTax: document.getElementById('totalMaintenancePaidOutputPreTax'),
            scenarioProfitRentInvestPreTax: document.getElementById('scenarioProfitRentInvestPreTax'),
            futurePortfolioValuePreTax: document.getElementById('futurePortfolioValuePreTax'),
            investmentProfitPreTaxOutput: document.getElementById('investmentProfitPreTaxOutput'),
            summaryInitialInvestmentRentPreTax: document.getElementById('summaryInitialInvestmentRentPreTax'),
            summarySP500RatePreTax: document.getElementById('summarySP500RatePreTax'),
            totalRentPaidOutputPreTax: document.getElementById('totalRentPaidOutputPreTax'),
            capitalDifferencePreTax: document.getElementById('capitalDifferencePreTax'),
            capitalDifferenceFavourPreTax: document.getElementById('capitalDifferenceFavourPreTax'),
            // Post-Tax
            scenarioProfitBuyPostTax: document.getElementById('scenarioProfitBuyPostTax'),
            futurePropertyValuePostTax: document.getElementById('futurePropertyValuePostTax'),
            propertyGainPreTaxOutput: document.getElementById('propertyGainPreTaxOutput'),
            propertySaleTaxRateOutput: document.getElementById('propertySaleTaxRateOutput'),
            propertyTaxAmountOutput: document.getElementById('propertyTaxAmountOutput'),
            scenarioProfitRentInvestPostTax: document.getElementById('scenarioProfitRentInvestPostTax'),
            futurePortfolioValuePostTax: document.getElementById('futurePortfolioValuePostTax'),
            investmentProfitPostTaxOutput: document.getElementById('investmentProfitPostTaxOutput'),
            portfolioGainPreTaxOutput: document.getElementById('portfolioGainPreTaxOutput'),
            investmentSaleTaxRateOutput: document.getElementById('investmentSaleTaxRateOutput'),
            investmentTaxAmountOutput: document.getElementById('investmentTaxAmountOutput'),
            capitalDifferencePostTax: document.getElementById('capitalDifferencePostTax'),
            capitalDifferenceFavourPostTax: document.getElementById('capitalDifferenceFavourPostTax')
        };


        function pmt(rate, nper, pv) {
            if (nper === 0) return 0; 
            if (rate === 0) return -pv / nper;
            const pvif = Math.pow(1 + rate, nper);
            if (pvif - 1 === 0) return 0; 
            return (-pv * rate * pvif) / (pvif - 1);
        }
        
        function updateInitialInvestmentInputState() {
            const type = configElements.initialInvestmentType.value;
            const apartmentCost = parseFloat(configElements.apartmentCost.value) || 0;
            let currentConfigValue = parseFloat(configElements.initialInvestmentConfigValue.value);
            let newConfigValue = currentConfigValue;

            if (type === 'percentage') {
                configElements.initialInvestmentUnitSuffix.textContent = '%';
                configElements.initialInvestmentConfigValue.step = '1';
                if (configElements.initialInvestmentUnitSuffix.dataset.previousType === 'value' && apartmentCost > 0) {
                    newConfigValue = Math.round(((currentConfigValue / apartmentCost) * 100) / 5) * 5;
                    if (newConfigValue > 100) newConfigValue = 100;
                    if (newConfigValue < 0) newConfigValue = 0;
                } else if (isNaN(currentConfigValue) || currentConfigValue > 100 || currentConfigValue < 0) {
                     newConfigValue = 30;
                }
                configElements.initialInvestmentConfigValue.value = newConfigValue.toFixed(0);
                configElements.initialInvestmentUnitSuffix.dataset.previousType = 'percentage';

            } else { // type === 'value'
                configElements.initialInvestmentUnitSuffix.textContent = 'EUR';
                configElements.initialInvestmentConfigValue.step = '1000';
                 if (configElements.initialInvestmentUnitSuffix.dataset.previousType === 'percentage' && apartmentCost > 0) {
                    newConfigValue = Math.round(((apartmentCost * currentConfigValue) / 100) / 1000) * 1000;
                 } else if (isNaN(currentConfigValue) || currentConfigValue < 0) {
                     newConfigValue = Math.round(((apartmentCost * 30) / 100) / 1000) * 1000; 
                 }
                configElements.initialInvestmentConfigValue.value = newConfigValue.toFixed(0);
                configElements.initialInvestmentUnitSuffix.dataset.previousType = 'value';
            }
        }


        function calculateAndDisplayResults() {
            const apartmentCost = parseFloat(configElements.apartmentCost.value) || 0;
            const initialInvestmentType = configElements.initialInvestmentType.value;
            let initialInvestmentConfigVal = parseFloat(configElements.initialInvestmentConfigValue.value);
            
            let actualInitialInvestment;
            if (initialInvestmentType === 'percentage') {
                if (isNaN(initialInvestmentConfigVal) || initialInvestmentConfigVal < 0 || initialInvestmentConfigVal > 100) initialInvestmentConfigVal = 30;
                configElements.initialInvestmentConfigValue.value = initialInvestmentConfigVal.toFixed(0);
                actualInitialInvestment = (apartmentCost * initialInvestmentConfigVal) / 100;
            } else { 
                if (isNaN(initialInvestmentConfigVal) || initialInvestmentConfigVal < 0) initialInvestmentConfigVal = 0;
                configElements.initialInvestmentConfigValue.value = initialInvestmentConfigVal.toFixed(0);
                actualInitialInvestment = initialInvestmentConfigVal;
            }
            if (actualInitialInvestment > apartmentCost) {
                actualInitialInvestment = apartmentCost;
                 if (initialInvestmentType === 'value') {
                    configElements.initialInvestmentConfigValue.value = actualInitialInvestment.toFixed(0);
                } else { 
                    configElements.initialInvestmentConfigValue.value = apartmentCost > 0 ? ((actualInitialInvestment / apartmentCost) * 100).toFixed(0) : '0';
                }
            }

            const numYears = parseInt(configElements.mortgageTermYears.value) || 25;
            const mortgageAnnualRatePercent = parseFloat(configElements.mortgageAnnualRate.value) || 0;
            const initialRent = parseFloat(configElements.initialMonthlyRent.value) || 0;
            const rentIndexRatePercent = parseFloat(configElements.rentIndexRate.value) || 0;
            const initialMaintenance = parseFloat(configElements.initialMonthlyMaintenance.value) || 0;
            const maintenanceIndexRatePercent = parseFloat(configElements.maintenanceIndexRate.value) || 0;
            const sp500RatePercent = parseFloat(configElements.sp500Rate.value) || 0;
            const propertyGrowthRatePercent = parseFloat(configElements.propertyGrowthRate.value) || 0;
            const propertySaleTaxRatePercent = parseFloat(configElements.propertySaleTaxRate.value) || 0;
            const investmentSaleTaxRatePercent = parseFloat(configElements.investmentSaleTaxRate.value) || 0;


            const mortgageLoanAmount = Math.max(0, apartmentCost - actualInitialInvestment);
            const mortgageAnnualInterestRate = mortgageAnnualRatePercent / 100;
            const monthlyMortgageInterestRate = mortgageAnnualInterestRate / 12;
            const numMonths = numYears * 12;
            
            let calculatedMonthlyMortgagePayment = 0;
            if (mortgageLoanAmount > 0 && numMonths > 0 && monthlyMortgageInterestRate >= 0) {
                 calculatedMonthlyMortgagePayment = -pmt(monthlyMortgageInterestRate, numMonths, mortgageLoanAmount);
                 if (isNaN(calculatedMonthlyMortgagePayment) || !isFinite(calculatedMonthlyMortgagePayment)) {
                    calculatedMonthlyMortgagePayment = 0; 
                 }
            } else if (mortgageLoanAmount <= 0) { 
                calculatedMonthlyMortgagePayment = 0;
            }

            const rentAnnualIndexRate = rentIndexRatePercent / 100;
            const maintenanceAnnualIndexRate = maintenanceIndexRatePercent / 100;
            const sp500AnnualReturn = sp500RatePercent / 100;
            const sp500MonthlyReturn = Math.pow(1 + sp500AnnualReturn, 1/12) - 1;
            const propertyAnnualGrowthRate = propertyGrowthRatePercent / 100;

            const monthlyReportData = [];
            let cumulativeNetFlow = 0;
            let remainingPrincipal = mortgageLoanAmount > 0 ? mortgageLoanAmount : 0;
            let totalInterestPaid = 0;
            let totalMaintenancePaid = 0;
            let totalRentPaid = 0;
            let portfolioValueRentInvest = actualInitialInvestment;


            for (let month = 1; month <= numMonths; month++) {
                const currentYearIndex = Math.floor((month - 1) / 12);
                
                const currentMonthlyMaintenance = initialMaintenance * Math.pow(1 + maintenanceAnnualIndexRate, currentYearIndex);
                totalMaintenancePaid += currentMonthlyMaintenance;

                const currentMonthlyRent = initialRent * Math.pow(1 + rentAnnualIndexRate, currentYearIndex);
                totalRentPaid += currentMonthlyRent;
                
                let interestPaidThisMonth = 0;
                let principalPaidThisMonth = 0;

                if (remainingPrincipal > 0 && calculatedMonthlyMortgagePayment > 0 && monthlyMortgageInterestRate >= 0) {
                    interestPaidThisMonth = remainingPrincipal * monthlyMortgageInterestRate;
                    principalPaidThisMonth = calculatedMonthlyMortgagePayment - interestPaidThisMonth;
                    
                    if (month === numMonths && remainingPrincipal > 0) { 
                        principalPaidThisMonth = remainingPrincipal;
                        interestPaidThisMonth = remainingPrincipal * monthlyMortgageInterestRate; 
                    } else if (remainingPrincipal - principalPaidThisMonth < 0.01 && remainingPrincipal > 0) { 
                        principalPaidThisMonth = remainingPrincipal;
                        interestPaidThisMonth = calculatedMonthlyMortgagePayment - principalPaidThisMonth; 
                        if (interestPaidThisMonth < 0) interestPaidThisMonth = 0;
                    }
                    totalInterestPaid += interestPaidThisMonth;
                    remainingPrincipal -= principalPaidThisMonth;
                    if (remainingPrincipal < 0.01) remainingPrincipal = 0;
                }

                const costBuyMonth = (mortgageLoanAmount > 0 ? calculatedMonthlyMortgagePayment : 0) + currentMonthlyMaintenance;
                const netFlowMonth = costBuyMonth - currentMonthlyRent;
                cumulativeNetFlow += netFlowMonth;

                portfolioValueRentInvest *= (1 + sp500MonthlyReturn);
                portfolioValueRentInvest += netFlowMonth;


                monthlyReportData.push({
                    month: month,
                    maintenance: currentMonthlyMaintenance,
                    interestPaid: interestPaidThisMonth,
                    rent: currentMonthlyRent,
                    buy_expenses: costBuyMonth,
                    net_flow: netFlowMonth
                });
            }
            
            // Pre-Tax Financial Outcome Summary Calculations
            const futurePropertyValuePreTaxVal = apartmentCost * Math.pow(1 + propertyAnnualGrowthRate, numYears);
            const scenarioProfitBuyPreTaxVal = futurePropertyValuePreTaxVal - actualInitialInvestment - totalInterestPaid - totalMaintenancePaid;
            const finalCapitalRentInvestPreTax = portfolioValueRentInvest;
            const totalCapitalInjectedPortfolio = actualInitialInvestment + cumulativeNetFlow;
            const investmentProfitPreTaxVal = finalCapitalRentInvestPreTax - totalCapitalInjectedPortfolio;
            const scenarioProfitRentInvestPreTaxVal = finalCapitalRentInvestPreTax - actualInitialInvestment - totalRentPaid;
            const capitalDifferenceValuePreTax = scenarioProfitRentInvestPreTaxVal - scenarioProfitBuyPreTaxVal;


            summaryElements.summaryTermYears.textContent = numYears;
            summaryElements.scenarioProfitBuyPreTax.textContent = scenarioProfitBuyPreTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.futurePropertyValuePreTax.textContent = futurePropertyValuePreTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.summaryInitialInvestmentBuyPreTax.textContent = actualInitialInvestment.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.totalInterestPaidOutputPreTax.textContent = totalInterestPaid.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.totalMaintenancePaidOutputPreTax.textContent = totalMaintenancePaid.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            
            summaryElements.scenarioProfitRentInvestPreTax.textContent = scenarioProfitRentInvestPreTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.futurePortfolioValuePreTax.textContent = finalCapitalRentInvestPreTax.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.investmentProfitPreTaxOutput.textContent = investmentProfitPreTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.summaryInitialInvestmentRentPreTax.textContent = actualInitialInvestment.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.summarySP500RatePreTax.textContent = sp500RatePercent.toFixed(2);
            summaryElements.totalRentPaidOutputPreTax.textContent = totalRentPaid.toLocaleString('ru-RU', {maximumFractionDigits: 0});

            summaryElements.capitalDifferencePreTax.textContent = capitalDifferenceValuePreTax.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            if (capitalDifferenceValuePreTax > 0) {
                summaryElements.capitalDifferenceFavourPreTax.textContent = `в пользу "Аренда + Инвестиции"`;
                summaryElements.capitalDifferencePreTax.classList.remove('text-red-600');
                summaryElements.capitalDifferencePreTax.classList.add('text-green-600');
            } else if (capitalDifferenceValuePreTax < 0) {
                summaryElements.capitalDifferenceFavourPreTax.textContent = `в пользу "Покупка недвижимости"`;
                summaryElements.capitalDifferencePreTax.classList.remove('text-green-600');
                summaryElements.capitalDifferencePreTax.classList.add('text-red-600');
            } else {
                summaryElements.capitalDifferenceFavourPreTax.textContent = `сценарии примерно равны`;
                summaryElements.capitalDifferencePreTax.classList.remove('text-green-600', 'text-red-600');
            }

            // Post-Tax Financial Outcome Summary Calculations
            const propertyGainPreTaxVal = Math.max(0, futurePropertyValuePreTaxVal - apartmentCost); 
            const propertyTaxAmountVal = propertyGainPreTaxVal * (propertySaleTaxRatePercent / 100);
            const futurePropertyValuePostTaxVal = futurePropertyValuePreTaxVal - propertyTaxAmountVal;
            const scenarioProfitBuyPostTaxVal = futurePropertyValuePostTaxVal - actualInitialInvestment - totalInterestPaid - totalMaintenancePaid;

            const portfolioGainPreTaxVal = investmentProfitPreTaxVal; // Same as investmentProfitPreTaxVal
            const investmentTaxAmountVal = portfolioGainPreTaxVal * (investmentSaleTaxRatePercent / 100);
            const futurePortfolioValuePostTaxVal = finalCapitalRentInvestPreTax - investmentTaxAmountVal;
            const investmentProfitPostTaxVal = futurePortfolioValuePostTaxVal - totalCapitalInjectedPortfolio;
            const scenarioProfitRentInvestPostTaxVal = futurePortfolioValuePostTaxVal - actualInitialInvestment - totalRentPaid;
            
            const capitalDifferenceValuePostTax = scenarioProfitRentInvestPostTaxVal - scenarioProfitBuyPostTaxVal;

            summaryElements.scenarioProfitBuyPostTax.textContent = scenarioProfitBuyPostTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.futurePropertyValuePostTax.textContent = futurePropertyValuePostTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.propertyGainPreTaxOutput.textContent = propertyGainPreTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.propertySaleTaxRateOutput.textContent = propertySaleTaxRatePercent.toFixed(2);
            summaryElements.propertyTaxAmountOutput.textContent = propertyTaxAmountVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});

            summaryElements.scenarioProfitRentInvestPostTax.textContent = scenarioProfitRentInvestPostTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.futurePortfolioValuePostTax.textContent = futurePortfolioValuePostTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.investmentProfitPostTaxOutput.textContent = investmentProfitPostTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.portfolioGainPreTaxOutput.textContent = portfolioGainPreTaxVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            summaryElements.investmentSaleTaxRateOutput.textContent = investmentSaleTaxRatePercent.toFixed(2);
            summaryElements.investmentTaxAmountOutput.textContent = investmentTaxAmountVal.toLocaleString('ru-RU', {maximumFractionDigits: 0});

            summaryElements.capitalDifferencePostTax.textContent = capitalDifferenceValuePostTax.toLocaleString('ru-RU', {maximumFractionDigits: 0});
             if (capitalDifferenceValuePostTax > 0) {
                summaryElements.capitalDifferenceFavourPostTax.textContent = `в пользу "Аренда + Инвестиции"`;
                summaryElements.capitalDifferencePostTax.classList.remove('text-red-600');
                summaryElements.capitalDifferencePostTax.classList.add('text-green-600');
            } else if (capitalDifferenceValuePostTax < 0) {
                summaryElements.capitalDifferenceFavourPostTax.textContent = `в пользу "Покупка недвижимости"`;
                summaryElements.capitalDifferencePostTax.classList.remove('text-green-600');
                summaryElements.capitalDifferencePostTax.classList.add('text-red-600');
            } else {
                summaryElements.capitalDifferenceFavourPostTax.textContent = `сценарии примерно равны`;
                summaryElements.capitalDifferencePostTax.classList.remove('text-green-600', 'text-red-600');
            }


            // Update Net Flow Table and Chart
            const tableBody = document.getElementById('investmentDataBody');
            tableBody.innerHTML = ''; 
            monthlyReportData.forEach(data => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = data.month;
                row.insertCell().textContent = data.maintenance.toFixed(2);
                row.insertCell().textContent = data.interestPaid.toFixed(2);
                row.insertCell().textContent = data.rent.toFixed(2);
                row.insertCell().textContent = data.buy_expenses.toFixed(2);
                const netFlowCell = row.insertCell();
                netFlowCell.textContent = data.net_flow.toFixed(2);
                netFlowCell.classList.add(data.net_flow >= 0 ? 'text-green-600' : 'text-red-600');
                netFlowCell.classList.add('font-medium');
            });

            document.getElementById('total-net-investment').textContent = `Итоговый чистый поток средств для уравнивания расходов за ${numYears} лет: ${cumulativeNetFlow.toFixed(2)} EUR`;

            if (netInvestmentChartInstance) {
                netInvestmentChartInstance.destroy();
            }
            const ctx = document.getElementById('netInvestmentChart').getContext('2d');
            netInvestmentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyReportData.map(d => `М ${d.month}`),
                    datasets: [{
                        label: 'Чистый поток доинвестиций/изъятий (EUR)',
                        data: monthlyReportData.map(d => d.net_flow),
                        backgroundColor: monthlyReportData.map(d => d.net_flow >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                        borderColor: monthlyReportData.map(d => d.net_flow >= 0 ? 'rgba(22, 163, 74, 1)' : 'rgba(220, 38, 38, 1)'),
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, 
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Сумма (EUR)', font: { size: 14 } },
                            ticks: { callback: function(value) { return value.toLocaleString('ru-RU') + ' EUR'; } }
                        },
                        x: {
                            title: { display: true, text: `Месяц (Всего ${numMonths})`, font: { size: 14 } },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: Math.max(10, Math.min(25, numMonths > 0 ? numMonths / 12 : 25)),
                                maxRotation: 90, 
                                minRotation: 45,
                                callback: function(value, index) {
                                   if (monthlyReportData && monthlyReportData[index]) {
                                       const monthNumber = monthlyReportData[index].month;
                                       if (numMonths <= 60 || (monthNumber -1) % 12 === 0 || numMonths === 0) { 
                                           return `М ${monthNumber}`;
                                       }
                                   }
                                   return null; 
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            enabled: true, mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.8)',
                            callbacks: {
                                title: function(tooltipItems) {
                                     if (tooltipItems.length > 0 && monthlyReportData[tooltipItems[0].dataIndex]) {
                                        const monthIndex = tooltipItems[0].dataIndex;
                                        const year = Math.floor(monthIndex / 12) + 1;
                                        const monthInYear = (monthIndex % 12) + 1;
                                        return `Месяц ${monthIndex + 1} (Год ${year}, мес. ${monthInYear})`;
                                    }
                                    return '';
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString('ru-RU', { style: 'currency', currency: 'EUR' });
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function handleInputChange() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (this && this.id === 'initialInvestmentType') { 
                     updateInitialInvestmentInputState(); 
                }
                calculateAndDisplayResults();
            }, 300); 
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            configElements.initialInvestmentType.addEventListener('change', handleInputChange);
            
            Object.values(configElements).forEach(element => {
                if (element && element.id !== 'initialInvestmentType' && element.id !== 'initialInvestmentUnitSuffix') { 
                     element.addEventListener('input', handleInputChange);
                }
            });
            
            updateInitialInvestmentInputState(); 
            calculateAndDisplayResults(); 
        });
    </script>
</body>
</html>
